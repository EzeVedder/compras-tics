name: COMPRAS TICS -> BigQuery (nuevo)

on:
  # Lo ejecutás manualmente desde la pestaña Actions
  workflow_dispatch: {}

jobs:
  run-compras-tics:
    runs-on: ubuntu-latest

    steps:
      # 1) Descargar SIEMPRE la última versión del repo
      - name: Checkout latest main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # 2) Debug: ver dónde estamos y qué archivos hay
      - name: Show repo contents (debug)
        run: |
          echo "PWD:"
          pwd
          echo "ls:"
          ls
          echo "----"
          echo "ls scrapers:"
          ls scrapers || echo "NO existe carpeta scrapers"
          echo "----"
          echo "ls compras_to_bigquery.py:"
          ls compras_to_bigquery.py || echo "NO existe compras_to_bigquery.py"

      # 3) Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4) Chrome para Selenium
      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: "stable"

      # 5) Instalar dependencias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 6) Crear archivo de credenciales desde el secret
      - name: Create service account key file
        env:
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$GCP_SERVICE_ACCOUNT_KEY" > sa-key.json

      # 7) Ejecutar scraper + BigQuery
      - name: Run scraper and upload to BigQuery
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          echo "PWD antes de ejecutar Python:"
          pwd
          echo "ls antes de ejecutar Python:"
          ls
          echo "Chequeando existencia de compras_to_bigquery.py..."
          if [ -f "compras_to_bigquery.py" ]; then
            echo "OK: compras_to_bigquery.py existe"
          else
            echo "ERROR: compras_to_bigquery.py NO existe en este directorio"
          fi
          python ./compras_to_bigquery.py \
            --credentials "sa-key.json" \
            --project-id "$GCP_PROJECT_ID" \
            --dataset "proceso_compras" \
            --table "procesos_tics"
